<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Pixel Fishing Game</title>
<style>
body {
  background: #222;
  color: #fff;
  font-family: monospace;
  text-align: center;
}

#game {
  width: 320px;
  height: 180px;
  margin: 20px auto;
  position: relative;
  border: 4px solid #222;
  overflow: hidden;
  image-rendering: pixelated;
  transform: scale(2);
  transform-origin: top center;
}

/* èƒŒæ™¯ tile */
#background {
  position: absolute;
  width: 320px;
  height: 120px;
  top: 0;
  left: 0;
}

/* å ´æ™¯å®¹å™¨ */
#scene {
  position: absolute;
  width: 100%;
  height: 120px;
  top: 0;
  left: 0;
}

/* ç©å®¶è§’è‰² */
#player {
  position: absolute;
  bottom: 16px;
  left: 40px;
  width: 16px;
  height: 24px;
  background: url('img/sprite.png') no-repeat;
  image-rendering: pixelated;
}

/* æ‹‰ç·šæ¢ */
#bar {
  position: relative;
  width: 160px;
  height: 12px;
  background: #8b0000;
  border: 2px solid #000;
  margin: 8px auto;
  display: none;
}

#success {
  position: absolute;
  height: 100%;
  background: #00aa00;
}

#pointer {
  position: absolute;
  top: -2px;
  width: 2px;
  height: 16px;
  background: #fff;
}

/* é­š */
.fish {
  position: absolute;
  width: 16px;
  height: 16px;
  background: url('img/sprite.png') no-repeat;
  image-rendering: pixelated;
}

/* UI icon */
#money {
  margin-top: 4px;
}
</style>
</head>
<body>

<h1>ğŸ£ Pixel Fishing Game</h1>

<div id="game">
  <div id="background"></div>
  <div id="scene">
    <div id="player"></div>
  </div>

  <div id="money">ğŸ’° 0</div>
  <button id="castBtn">æ‹‹ç«¿</button>

  <div id="bar">
    <div id="success"></div>
    <div id="pointer"></div>
  </div>
</div>

<script>
/* ---------- ç‹€æ…‹ ---------- */
let gameState = "IDLE";
let money = 0;
let currentFish = null;

/* ---------- æ‹‰ç·š ---------- */
let pointer = 0.5, direction = 1, progress = 0, danger = 0, holding = false, lastTime = null;

/* ---------- DOM ---------- */
const playerEl = document.getElementById("player");
const moneyEl = document.getElementById("money");
const barEl = document.getElementById("bar");
const successEl = document.getElementById("success");
const pointerEl = document.getElementById("pointer");
const castBtn = document.getElementById("castBtn");
const sceneEl = document.getElementById("scene");
const backgroundEl = document.getElementById("background");

/* ---------- ç²¾éˆ sheet åˆ‡å‰²è³‡è¨Š ---------- */
const sprite = {
  player: { row:0, width:16, height:24, idle:[0,16], fishing:[32,48] },
  fish: { row:1, width:16, height:16, map: {
    "å°é­š":[0,16], "ä¸­é­š":[32,48], "å¤§é­š":[64,80]
  }},
  effect: { row:2, width:32, height:16, map:{hit:0, success:32, fail:64}},
  ui: { row:3, width:16, height:16, map:{coin:0, rod:16}},
  bg: { row:4, width:32, height:32, map:{water:0, grass:32, wood:64}}
};

/* ---------- é­šè³‡æ–™ ---------- */
const fishTable = [
  { name:"å°é­š", price:10, reelTime:2, successZone:0.4, speed:0.6 },
  { name:"ä¸­é­š", price:30, reelTime:3, successZone:0.25, speed:1.0 },
  { name:"å¤§é­š", price:80, reelTime:4, successZone:0.15, speed:1.4 }
];

/* ---------- èƒŒæ™¯ tile ---------- */
function drawBackground() {
  backgroundEl.style.backgroundImage = "url('img/sprite.png')";
  backgroundEl.style.backgroundRepeat = "repeat";
  backgroundEl.style.backgroundPosition = `0px -${sprite.bg.row*32}px`;
  backgroundEl.style.backgroundSize = "auto";
}
drawBackground();

/* ---------- æ‹‹ç«¿ ---------- */
castBtn.onclick = () => {
  if(gameState !== "IDLE") return;
  gameState="WAITING";
  setPlayerFrame('fishing',0);
  setTimeout(()=>{
    startReel();
  }, Math.random()*2000+1000);
};

/* ---------- æ‹‰ç·š ---------- */
function startReel(){
  currentFish = fishTable[Math.floor(Math.random()*fishTable.length)];
  pointer=0.5; progress=0; danger=0;
  barEl.style.display="block";
  successEl.style.left=(0.5-currentFish.successZone/2)*160+"px";
  successEl.style.width=currentFish.successZone*160+"px";
  lastTime = performance.now();
  spawnFish();
  requestAnimationFrame(loop);
}

function loop(time){
  if(gameState!=="REELING" && gameState!=="WAITING") return;
  if(gameState==="WAITING"){ gameState="REELING"; }
  const dt=(time-lastTime)/1000; lastTime=time;

  pointer += dt*currentFish.speed*(holding?1:-1);
  pointer = Math.max(0,Math.min(1,pointer));

  const left = 0.5-currentFish.successZone/2;
  const right = 0.5+currentFish.successZone/2;
  if(pointer>=left && pointer<=right){ progress+=dt; danger=Math.max(0,danger-dt);}
  else { danger+=dt; }

  pointerEl.style.left = pointer*160+"px";
  animateFish();

  if(progress>=currentFish.reelTime){ money+=currentFish.price; moneyEl.textContent="ğŸ’° "+money; endReel("æˆåŠŸé‡£åˆ° "+currentFish.name); return;}
  if(danger>=1.5){ endReel("é­šè·‘æ‰äº†ï¼"); return;}
  requestAnimationFrame(loop);
}

/* ---------- çµæŸ ---------- */
function endReel(msg){
  alert(msg);
  barEl.style.display="none";
  gameState="IDLE";
  setPlayerFrame('idle',0);
  removeFish();
}

/* ---------- ç©å®¶æ“ä½œ ---------- */
document.addEventListener("mousedown",()=>holding=true);
document.addEventListener("mouseup",()=>holding=false);
document.addEventListener("touchstart",()=>holding=true);
document.addEventListener("touchend",()=>holding=false);

/* ---------- ç©å®¶ç²¾éˆæ§åˆ¶ ---------- */
function setPlayerFrame(action,index){
  const x = sprite.player[action][index];
  const y = sprite.player.row*24;
  playerEl.style.backgroundPosition = `-${x}px -${y}px`;
  playerEl.style.width = sprite.player.width+"px";
  playerEl.style.height = sprite.player.height+"px";
}

/* ---------- é­šå…ƒç´  ---------- */
let fishEl = null;
let fishFrameIndex=0;
function spawnFish(){
  fishEl = document.createElement("div");
  fishEl.className="fish";
  sceneEl.appendChild(fishEl);
  setFishFrame(0);
  fishEl.style.bottom="40px";
  fishEl.style.left="150px";
}

function removeFish(){
  if(fishEl){ fishEl.remove(); fishEl=null; }
}

function setFishFrame(frame){
  const map = sprite.fish.map[currentFish.name];
  const x = map[frame];
  const y = sprite.fish.row*16;
  fishEl.style.backgroundPosition = `-${x}px -${y}px`;
  fishEl.style.width=sprite.fish.width+"px";
  fishEl.style.height=sprite.fish.height+"px";
}

function animateFish(){
  if(!fishEl) return;
  fishFrameIndex = (fishFrameIndex+1)%2;
  setFishFrame(fishFrameIndex);
}
</script>

</body>
</html>
