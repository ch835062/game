<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FC戰鬥畫面 100%風格</title>
<style>
body{
  margin:0;
  background:#000;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  height:100vh;
}
canvas{
  width:512px;
  height:480px;
  image-rendering:pixelated;
}
.controls{
  margin-top:10px;
}
button{
  font-size:20px;
  padding:10px 20px;
  margin:0 10px;
}
</style>
</head>
<body>

<canvas id="game" width="256" height="240"></canvas>

<div class="controls">
  <button id="pull">拉</button>
  <button id="release">放</button>
</div>

<script>
const c = document.getElementById("game");
const ctx = c.getContext("2d");
ctx.imageSmoothingEnabled=false;

let frame=0;
let tension=0;
let battle=false;
let hookedFish=null;
let lineLength=160;

/* ===============================
   背景
================================= */

function drawWater(){
  ctx.fillStyle="#5ea9ff"; ctx.fillRect(0,40,256,40);
  ctx.fillStyle="#3f7cff"; ctx.fillRect(0,80,256,60);
  ctx.fillStyle="#2f5be0"; ctx.fillRect(0,140,256,50);
  ctx.fillStyle="#1f3fc0"; ctx.fillRect(0,190,256,50);

  ctx.fillStyle="#ffffff";
  for(let x=0;x<256;x+=16){
    ctx.fillRect(x,38,8,2);
    ctx.fillRect(x+4,36,6,2);
  }
}

function drawMountains(){
  ctx.fillStyle="#78d040";
  ctx.fillRect(0,10,60,20);
  ctx.fillRect(60,5,50,25);
  ctx.fillRect(110,12,80,18);
  ctx.fillRect(190,8,66,22);

  ctx.fillStyle="#2c8c20";
  for(let x=0;x<256;x+=8){
    ctx.fillRect(x,30,6,10);
  }
}

function drawRiverBed(){
  ctx.fillStyle="#9ca8cc";
  for(let y=200;y<240;y+=8){
    for(let x=0;x<256;x+=8){
      ctx.fillRect(x,y,6,6);
    }
  }
  ctx.fillStyle="#444";
  ctx.fillRect(20,215,40,3);
  ctx.fillRect(190,210,30,3);
}

/* ===============================
   魚線
================================= */

function drawFishingLine(){
  ctx.strokeStyle="#000";
  ctx.beginPath();
  ctx.moveTo(128,0);

  if(hookedFish){
    ctx.lineTo(hookedFish.x+8,hookedFish.y);
  }else{
    ctx.lineTo(128,lineLength);
  }

  ctx.stroke();
}

/* ===============================
   點陣魚
================================= */

const fishSprite = [
"000000111111000000",
"000011222222110000",
"001122222222221100",
"012222233332222211",
"012222233332222211",
"001122222222221100",
"000011222222110000",
"000000111111000000"
];

const palette = {
  "0":null,
  "1":"#000000",
  "2":"#cfd6dd",
  "3":"#9ea6b3"
};

class Fish{
  constructor(x,y,dir){
    this.x=x;
    this.y=y;
    this.dir=dir;
    this.speed=0.4;
    this.state="swim";
  }

  update(){
    if(!battle){
      this.x+=this.speed*this.dir;
      if(this.x>240||this.x<20) this.dir*=-1;

      // 靠近魚線機率咬餌
      if(Math.abs(this.x-128)<8 && Math.random()<0.01){
        this.state="bite";
      }

      if(this.state==="bite" && frame%40===0){
        battle=true;
        hookedFish=this;
      }
    }else if(hookedFish===this){
      // 掙扎
      this.x+= (Math.random()-0.5)*3;
      tension+=Math.abs(this.x-128)*0.02;

      if(tension>100){
        alert("爆線！");
        reset();
      }
    }
  }

  draw(){
    ctx.save();
    ctx.translate(this.x,this.y);
    ctx.scale(this.dir,1);

    for(let r=0;r<fishSprite.length;r++){
      for(let col=0;col<fishSprite[r].length;col++){
        let p=fishSprite[r][col];
        if(palette[p]){
          ctx.fillStyle=palette[p];
          ctx.fillRect(col,r,1,1);
        }
      }
    }

    ctx.restore();

    if(this.state==="bite" && !battle && frame%20<10){
      ctx.fillStyle="#ffff00";
      ctx.fillText("!",this.x,this.y-10);
    }
  }
}

let fishes=[
  new Fish(80,120,1),
  new Fish(180,150,-1)
];

/* ===============================
   張力條
================================= */

function drawTensionBar(){
  ctx.fillStyle="#000";
  ctx.fillRect(230,20,10,180);

  ctx.fillStyle="#00ff00";
  ctx.fillRect(230,200-tension*1.5,10,tension*1.5);
}

/* ===============================
   控制按鈕
================================= */

document.getElementById("pull").onclick=()=>{
  if(battle){
    tension-=5;
    if(tension<0) tension=0;
  }
};

document.getElementById("release").onclick=()=>{
  if(battle){
    tension+=3;
  }
};

function reset(){
  tension=0;
  battle=false;
  hookedFish=null;
  fishes=[
    new Fish(80,120,1),
    new Fish(180,150,-1)
  ];
}

/* ===============================
   主迴圈
================================= */

function loop(){

  ctx.clearRect(0,0,256,240);

  drawMountains();
  drawWater();
  drawRiverBed();
  drawFishingLine();

  fishes.forEach(f=>{
    f.update();
    f.draw();
  });

  if(battle) drawTensionBar();

  frame++;
  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>