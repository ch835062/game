<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>外殼水體 + 頂層波浪</title>
<style>
body{margin:0;background:#0b0f14;overflow:hidden;}
canvas{display:block;}
</style>
</head>
<body>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

const size = 8;
const depthLayers = 25;
const reservedTop = 15;
const mapLayer = depthLayers - reservedTop - 1;

let time = 0;

function isoToScreen(x, y, z, tileW, tileH, tileZ){
  return {
    x: (x - y) * tileW / 2,
    y: (x + y) * tileH / 2 - z * tileZ
  };
}

function drawFace(points, color, alpha=1){
  ctx.globalAlpha = alpha;
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.moveTo(points[0].x, points[0].y);
  for(let i=1;i<points.length;i++){
    ctx.lineTo(points[i].x, points[i].y);
  }
  ctx.closePath();
  ctx.fill();
  ctx.globalAlpha = 1;
}

function render(){
  time += 0.05;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const tileW = Math.min(canvas.width,canvas.height)/8;
  const tileH = tileW/2;
  const tileZ = tileW/2;

  const centerX = canvas.width/2;
  const centerY = canvas.height*0.65;

  // ===== 畫水外殼 =====
  for(let z=0; z<=mapLayer; z++){

    const depthRatio = (mapLayer - z)/mapLayer;
    const alpha = 0.9 - depthRatio*0.6;

    const light = 70 - depthRatio*45;
    const baseColor = `hsl(205,70%,${light}%)`;

    // 左側面 (x=0)
    for(let y=0; y<size; y++){
      const p = isoToScreen(0,y,z,tileW,tileH,tileZ);
      const sx = p.x+centerX;
      const sy = p.y+centerY;

      drawFace([
        {x:sx-tileW/2,y:sy-tileH/2-tileZ},
        {x:sx-tileW/2,y:sy-tileH/2},
        {x:sx,y:sy},
        {x:sx,y:sy-tileZ}
      ], baseColor, alpha);
    }

    // 右側面 (y=0)
    for(let x=0; x<size; x++){
      const p = isoToScreen(x,0,z,tileW,tileH,tileZ);
      const sx = p.x+centerX;
      const sy = p.y+centerY;

      drawFace([
        {x:sx+tileW/2,y:sy-tileH/2-tileZ},
        {x:sx+tileW/2,y:sy-tileH/2},
        {x:sx,y:sy},
        {x:sx,y:sy-tileZ}
      ], baseColor, alpha);
    }

    // 底面 (z=0)
    if(z===0){
      for(let x=0;x<size;x++){
        for(let y=0;y<size;y++){
          const p = isoToScreen(x,y,0,tileW,tileH,tileZ);
          const sx = p.x+centerX;
          const sy = p.y+centerY;

          drawFace([
            {x:sx,y:sy},
            {x:sx+tileW/2,y:sy-tileH/2},
            {x:sx,y:sy-tileH},
            {x:sx-tileW/2,y:sy-tileH/2}
          ], baseColor, alpha);
        }
      }
    }
  }

  // ===== 畫最頂層水面（含波浪）=====
  for(let x=0;x<size;x++){
    for(let y=0;y<size;y++){

      const wave =
        Math.sin(time + x*0.6 + y*0.6) * tileZ*0.2;

      const p = isoToScreen(x,y,mapLayer,tileW,tileH,tileZ);
      const sx = p.x+centerX;
      const sy = p.y+centerY - wave;

      const light = 75;
      const color = `hsl(205,75%,${light}%)`;

      drawFace([
        {x:sx,y:sy-tileZ},
        {x:sx+tileW/2,y:sy-tileH/2-tileZ},
        {x:sx,y:sy-tileH-tileZ},
        {x:sx-tileW/2,y:sy-tileH/2-tileZ}
      ], color, 0.95);
    }
  }

  requestAnimationFrame(render);
}

render();
</script>
</body>
</html>