<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>Pixel Fishing Game</title>
<style>
  body {
    background: #222;
    color: #fff;
    font-family: monospace;
    text-align: center;
  }

  #game {
    width: 320px;
    height: 180px;
    margin: 20px auto;
    background: #5aa9e6;
    position: relative;
    border: 4px solid #222;
    image-rendering: pixelated;
    transform: scale(2);
    transform-origin: top center;
  }

  #background {
    position: absolute;
    width: 320px;
    height: 120px;
    background-image: url('img/water.png');
    background-repeat: repeat;
    image-rendering: pixelated;
    top: 0;
    left: 0;
  }

  #scene {
    position: absolute;
    width: 100%;
    height: 120px;
    top: 0;
    left: 0;
  }

  #player {
    position: absolute;
    bottom: 16px;
    left: 40px;
    width: 16px;
    height: 24px;
    image-rendering: pixelated;
  }

  #bar {
    position: relative;
    width: 160px;
    height: 12px;
    background: #8b0000;
    border: 2px solid #000;
    margin: 8px auto;
    display: none;
  }

  #success {
    position: absolute;
    height: 100%;
    background: #00aa00;
  }

  #pointer {
    position: absolute;
    top: -2px;
    width: 2px;
    height: 16px;
    background: #fff;
  }

  #money {
    margin-top: 4px;
  }
</style>
</head>
<body>

<h1>ðŸŽ£ Pixel Fishing Game</h1>

<div id="game">
  <div id="background"></div>
  <div id="scene">
    <img id="player" src="img/player_idle.png">
  </div>

  <div id="money">ðŸ’° 0</div>
  <button id="castBtn">æ‹‹ç«¿</button>

  <div id="bar">
    <div id="success"></div>
    <div id="pointer"></div>
  </div>
</div>

<script>
/* ---------- ç‹€æ…‹ ---------- */
let gameState = "IDLE";
let money = 0;
let currentFish = null;

/* ---------- æ‹‰ç·š ---------- */
let pointer = 0.5, direction = 1, progress = 0, danger = 0, holding = false, lastTime = null;

/* ---------- DOM ---------- */
const playerEl = document.getElementById("player");
const statusEl = document.getElementById("game"); // ç”¨æ–¼ debug
const moneyEl = document.getElementById("money");
const barEl = document.getElementById("bar");
const successEl = document.getElementById("success");
const pointerEl = document.getElementById("pointer");
const castBtn = document.getElementById("castBtn");
const sceneEl = document.getElementById("scene");

/* ---------- é­šè³‡æ–™ ---------- */
const fishTable = [
  { name:"å°é­š", price:10, reelTime:2, successZone:0.4, speed:0.6 },
  { name:"ä¸­é­š", price:30, reelTime:3, successZone:0.25, speed:1.0 },
  { name:"å¤§é­š", price:80, reelTime:4, successZone:0.15, speed:1.4 }
];

/* ---------- æ‹‹ç«¿ ---------- */
castBtn.onclick = () => {
  if(gameState !== "IDLE") return;
  gameState="WAITING";
  playerEl.src="img/player_fishing.png";

  setTimeout(()=>{
    startReel();
  }, Math.random()*2000+1000);
};

/* ---------- æ‹‰ç·š ---------- */
function startReel(){
  currentFish = fishTable[Math.floor(Math.random()*fishTable.length)];
  pointer=0.5; progress=0; danger=0;
  barEl.style.display="block";
  successEl.style.left=(0.5-currentFish.successZone/2)*160+"px";
  successEl.style.width=currentFish.successZone*160+"px";

  lastTime = performance.now();
  requestAnimationFrame(loop);

  spawnFish();
}

function loop(time){
  if(gameState!=="REELING" && gameState!=="WAITING" && gameState!=="HOOK") return;
  if(gameState==="WAITING"){ gameState="REELING"; }
  const dt=(time-lastTime)/1000; lastTime=time;

  pointer += dt*currentFish.speed*(holding?1:-1);
  if(pointer<0) pointer=0;
  if(pointer>1) pointer=1;

  const left = 0.5-currentFish.successZone/2;
  const right = 0.5+currentFish.successZone/2;
  if(pointer>=left && pointer<=right){
    progress+=dt;
    danger=Math.max(0,danger-dt);
  } else {
    danger+=dt;
  }

  pointerEl.style.left = pointer*160+"px";

  if(progress>=currentFish.reelTime){
    money += currentFish.price;
    moneyEl.textContent="ðŸ’° "+money;
    endReel("æˆåŠŸé‡£åˆ° "+currentFish.name);
    return;
  }
  if(danger>=1.5){
    endReel("é­šè·‘æŽ‰äº†ï¼");
    return;
  }

  requestAnimationFrame(loop);
}

/* ---------- çµæŸ ---------- */
function endReel(msg){
  alert(msg);
  barEl.style.display="none";
  gameState="IDLE";
  playerEl.src="img/player_idle.png";
  removeFish();
}

/* ---------- çŽ©å®¶æ“ä½œ ---------- */
document.addEventListener("mousedown",()=>holding=true);
document.addEventListener("mouseup",()=>holding=false);
document.addEventListener("touchstart",()=>holding=true);
document.addEventListener("touchend",()=>holding=false);

/* ---------- é­šå…ƒç´  ---------- */
let fishEl = null;
function spawnFish(){
  fishEl = document.createElement("img");
  fishEl.src = `img/fish_${currentFish.name}.png`;
  fishEl.style.position="absolute";
  fishEl.style.width="16px"; fishEl.style.height="16px";
  fishEl.style.bottom="40px"; fishEl.style.left="150px";
  fishEl.style.imageRendering="pixelated";
  sceneEl.appendChild(fishEl);
}
function removeFish(){
  if(fishEl){ fishEl.remove(); fishEl=null; }
}
</script>

</body>
</html>
